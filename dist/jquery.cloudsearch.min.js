!function(e){var a={cloudSearch:{url:"",key:""},googleGeocodeApi:{key:null,url:"https://maps.googleapis.com/maps/api/geocode/json",language:"en"},geoSearch:{lat:null,lng:null,fieldName:"_distance",cloudFieldName:null,unit:"K",maxDistance:null},searchParms:{q:"matchall","q.parser":"structured",return:"_all_fields",size:10,sort:"_score desc",start:0,facets:[],filter:null},facets:{facet:'<a href="#"/>',facetClass:"facet",titleWrapper:"<h2/>",title:'<a href="#"/>',titleClass:"",titleOnClick:function(){},titleWrapperClass:"facet-title",container:"#facets",wrapperContainer:"<ul/>",wrapperContainerClass:"facet-list",wrapper:"<li/>",wrapperClass:"facet-item",showCount:!0,countWrapper:null,countWrapperClass:null,facetOnClick:function(t){t.preventDefault();var r=e(this).data("cloudsearchFacetName")+"|"+e(this).data("cloudsearchFacetValue");if(-1!=a.facetsSelected.indexOf(r))return;a.facetsSelected.push(r),a.facetsApplied.onChange.call(a.facetsSelected.slice(0)),a.facets.onFacetSelect.call(a.facetsSelected.slice(0)),c()},searchMode:"and",onFacetSelect:function(){var t=a.facetsApplied;if(!t.container)return;var r=this.pop(),l=e(t.container),s=r.split("|");if(-1!=t.ignoreFacets.indexOf(s[0]))return;e("<a/>").text(s[1]).attr({href:"#"}).attr(t.extraAttributes).data("value",r).addClass(t.class).on("click",function(){a.facetsSelected.splice(a.facetsSelected.indexOf(e(this).data("value")),1),a.facetsApplied.onChange.call(a.facetsSelected.slice(0)),e(this).remove(),c()}).appendTo(l)},groupWrapper:"<div/>",groupWrapperClass:"group"},facetsApplied:{container:null,class:"selected-facet",extraAttributes:{},ignoreFacets:[],onChange:function(){}},facetsDictionary:null,facetsSelected:[],results:{container:"#results",template:null,onCreate:function(){},alwaysClearContainer:!1},urlParameters:{address:"a",latitude:"l",longitude:"ln",latlong:null,search:"q"},onResults:function(){(function(r){var c=a.results,l=e(c.container);if(!l||!r.hits.hit)return;(c.alwaysClearContainer||0==a.searchParms.skip)&&l.html("");e(r.hits.hit).each(function(r,s){var o=s.fields;if(c.template){var n=e(c.template);e(':not([data-cloudsearch-field=""])',n).not().each(function(r,c){var l=e(c).data("cloudsearchField"),o="";if(l&&s.fields[l])o=s.fields[l];else if(l==a.geoSearch.fieldName&&t.isGeoSearch&&s[a.geoSearch.cloudFieldName]){var n=s[a.geoSearch.cloudFieldName];o=function(e,a,t,r,c){var l=Math.PI*e/180,s=Math.PI*t/180,o=a-r,n=Math.PI*o/180,i=Math.sin(l)*Math.sin(s)+Math.cos(l)*Math.cos(s)*Math.cos(n);i>1&&(i=1);i=60*(i=180*(i=Math.acos(i))/Math.PI)*1.1515,"K"==c&&(i*=1.609344);"N"==c&&(i*=.8684);return i}(a.geoSearch.lat,a.geoSearch.lng,n.coordinates[1],n.coordinates[0],a.geoSearch.unit)}var i=e(c).data("cloudsearchValueFormat");i&&window[i]&&(o=window[i](o,s)),l&&e(c).html(o)}),l.append(n),c.onCreate.call(n)}else{var i=e("<ul/>"),d=e("<hr/>");e(Object.keys(o)).each(function(a,t){if(!o[t]||""==o[t])return!0;var r=e("<li/>").text(t+" : ").appendTo(i);e("<strong/>").text(o[t]).appendTo(r)}),i.appendTo(l),d.appendTo(l),c.onCreate.call(i)}})})(this),a.onLoad.call(this,t)},onLoad:function(){},debug:!1},t={waitingLatLong:!1,isGeoSearch:!1,totalResults:0,initialized:!1};function r(e){l("Google Geocode return:"),l(e);"OK"==e.status&&e.results.length>0&&(a.geoSearch.lat=e.results[0].geometry.location.lat,a.geoSearch.lng=e.results[0].geometry.location.lng),t.waitingLatLong=!1,c()}function c(){if(t.isGeoSearch=!1,!t.waitingLatLong){if(a.geoSearch.lat&&a.geoSearch.lng&&(l("Geo searching..."),l(a.geoSearch.lat),l(a.geoSearch.lng),t.isGeoSearch=!0,!a.searchParms.orderby||0==a.searchParms.orderby.indexOf(a.geoSearch.fieldName))){var r="geo.distance("+a.geoSearch.cloudFieldName;r+=", geography'POINT("+a.geoSearch.lng+" "+a.geoSearch.lat+")')",a.searchParms.orderby&&-1!=a.searchParms.orderby.indexOf(" desc")&&(r+=" desc"),a.searchParms.orderby=r}var c=null,s=a.searchParms.filter;if(a.facetsSelected.length>0){var o=[];a.facetsSelected.forEach(function(e,a){var t=e.split("|");o.push(t[0]+"/any(m: m eq '"+t[1].replace(/[']/gi,"''")+"')")}),c=o.join(" "+a.facets.searchMode+" "),s&&(c=a.searchParms.filter+" "+a.facets.searchMode+" "+c)}if(t.isGeoSearch&&a.geoSearch.maxDistance){l("Filter Geo searching by distance : "+a.geoSearch.maxDistance);var n="geo.distance("+a.geoSearch.cloudFieldName+", geography'POINT("+a.geoSearch.lng+" "+a.geoSearch.lat+")') le "+a.geoSearch.maxDistance;c?c+=" and "+n:c=n}c&&(a.searchParms.filter=c);var i={crossDomain:!0,url:a.cloudSearch.url,method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-Api-Key":a.cloudSearch.key,"Cache-Control":"no-cache"},data:a.searchParms};e.ajax(i).done(function(e){t.totalResults=e.hits.found>0?e.hits.found:-1,a.onResults.call(e,t)})}}function l(e){a.debug&&window.console&&window.console.log&&window.console.log(e)}function s(e){if(!e)return null;var a,t,r=decodeURIComponent(window.location.search.substring(1)).split("&");for(t=0;t<r.length;t++)if((a=r[t].split("="))[0]===e)return void 0===a[1]||a[1];return null}e.fn.cloudsearch=function(l,o){switch(o||(o="search"),l&&(l.googleGeocodeApi&&(l.googleGeocodeApi=e.extend(a.googleGeocodeApi,l.googleGeocodeApi)),l.searchParms&&(l.searchParms=e.extend(a.searchParms,l.searchParms)),l.facets&&(l.facets=e.extend(a.facets,l.facets)),l.facetsApplied&&(l.facetsApplied=e.extend(a.facetsApplied,l.facetsApplied)),l.results&&(l.results=e.extend(a.results,l.results)),l.geoSearch&&(l.geoSearch=e.extend(a.geoSearch,l.geoSearch)),l.urlParameters&&(l.urlParameters=e.extend(a.urlParameters,l.urlParameters)),a=e.extend(a,l),function(){var c=a.urlParameters,l=s(c.address),o=s(c.latitude),n=s(c.longitude),i=s(c.latlong),d=s(c.search);i&&-1!=i.indexOf(",")&&(o=i.split(",")[0],n=i.split(",")[1]);d&&(a.searchParms.q=d);o&&n&&(a.geoSearch.lat=o,a.geoSearch.lng=n);if(l&&!o&&!n&&!i){var u=function(c){var l=a.googleGeocodeApi;if(!l.key)return;t.waitingLatLong=!0;var s=l.url;s+=-1!=s.indexOf("?")?"&":"?",s+="key="+l.key,s+="&address="+c,s+="&language="+l.language,e.getJSON(s,r)}(l);u&&(o=u[0],n=u[1])}}()),t.initialized||e(a.facetsSelected).each(function(e,t){a.facets.onFacetSelect.call([t])}),o){case"search":c();break;case"resetFacets":a.facetsSelected=[],a.facets.onFacetSelect.call(a.facetsSelected),c()}return t.initialized=!0,this}}(jQuery);